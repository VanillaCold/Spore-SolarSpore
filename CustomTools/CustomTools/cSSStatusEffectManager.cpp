#include "stdafx.h"
#include "cSSStatusEffectManager.h"

/// AUTOGENERATED METHODS ///

int cSSStatusEffectManager::AddRef() {
	return Simulator::cStrategy::AddRef();
}
int cSSStatusEffectManager::Release() {
	return Simulator::cStrategy::Release();
}

const char* cSSStatusEffectManager::GetName() const {
	return "CustomTools::cSSStatusEffectManager";
}

bool cSSStatusEffectManager::Write(Simulator::ISerializerStream* stream)
{
	return Simulator::ClassSerializer(this, ATTRIBUTES).Write(stream);
}
bool cSSStatusEffectManager::Read(Simulator::ISerializerStream* stream)
{
	return Simulator::ClassSerializer(this, ATTRIBUTES).Read(stream);
}

/// END OF AUTOGENERATED METHODS ///
////////////////////////////////////

Simulator::Attribute cSSStatusEffectManager::ATTRIBUTES[] = {
	// Add more attributes here
	// This one must always be at the end
	Simulator::Attribute()
};

void cSSStatusEffectManager::Initialize() {
	sInstance = this;
	activeStatusEffects = map < cCombatantPtr, cSSStatusEffectManager::SSStatusEffect *> ();
}

void cSSStatusEffectManager::Dispose() {
	
}

void cSSStatusEffectManager::Update(int deltaTime, int deltaGameTime) {
	vector<cCombatantPtr> invalidStatuses{};
	for(auto i = activeStatusEffects.begin(); i != activeStatusEffects.end();i++)
	{
		auto combatant = i.mpNode->mValue.first;
		auto status = i.mpNode->mValue.second;
		if (!combatant || combatant->ToGameData()->mbIsDestroyed || combatant->mHealthPoints <= 0)
		{
			SporeDebugPrint("wooeeoo");
			invalidStatuses.push_back(combatant);
		}

		else if (status->mTimer <= 0)
		{
			invalidStatuses.push_back(combatant);
		}
		else
		{
			status->Update(deltaGameTime / 1000.0f);
		}
	}

	for each (cCombatantPtr removal in invalidStatuses)
	{
		activeStatusEffects[removal]->End();
		activeStatusEffects.erase(removal);
	}
}

bool cSSStatusEffectManager::WriteToXML(Simulator::XmlSerializer* writexml)
{
	return false;
}

cSSStatusEffectManager* cSSStatusEffectManager::Get()
{
	return sInstance;
}

void cSSStatusEffectManager::AddStatusEffect(cCombatantPtr combatant, uint32_t instanceID)
{
	activeStatusEffects[combatant] = new cSSStatusEffectManager::SSStatusEffect(instanceID,combatant);
}

cSSStatusEffectManager* cSSStatusEffectManager::sInstance;